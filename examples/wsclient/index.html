<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
  </head>

  <body>
    <ul>
      <li>call foo</li>
      <li id="call_foo"></li>
      <li>subscribe bar</li>
      <li id="subscribe_bar"></li>
      <li>call foo tls</li>
      <li id="call_foo_tls"></li>
      <li>subscribe bar tls</li>
      <li id="subscribe_bar_tls"></li>
    </ul>
    <script type="module">
      import init, {
        call_foo,
        connect_ws,
        connect_wss,
        subscribe_bar,
      } from "./pkg/wsclient.js";
      function wait() {
        return new Promise((res) => setTimeout(res, 1000));
      }
      async function run() {
        await init();
        console.log("init finished");
        await connect_ws();
        console.log("connect websocket finished");
        await connect_wss();
        console.log("connect websocket tls finished");
        function bar() {
          subscribe_bar((val) => {
            if (val instanceof Error) {
              console.error("subscribe_bar", val);
              setTimeout(bar, 5000);
              return;
            }
            document.getElementById("subscribe_bar").innerText = val;
          }, false);
        }
        async function foo() {
          let i = 0;
          while (true) {
            try {
              document.getElementById("call_foo").innerText = await call_foo(
                i++,
                true
              );
            } catch (e) {
              console.error("foo:", e);
            }
            await wait();
          }
        }
        function bar_tls() {
          subscribe_bar((val) => {
            if (val instanceof Error) {
              console.error("subscribe_bar_tls", val);
              setTimeout(bar_tls, 5000);
              return;
            }
            document.getElementById("subscribe_bar_tls").innerText = val;
          }, true);
        }
        async function foo_tls() {
          let i = 0;
          while (true) {
            try {
              document.getElementById(
                "call_foo_tls"
              ).innerText = await call_foo(i++, true);
            } catch (e) {
              console.error("foo tls:", e);
            }
            await wait();
          }
        }
        bar_tls();
        bar();
        foo_tls();
        foo();
      }
      run();
    </script>
  </body>
</html>
